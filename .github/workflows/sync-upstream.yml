name: 'Sync from Public Repo'

on:
  # Run every 10 minutes
  schedule:
    - cron: '*/10 * * * *'
  # Allow manual running from the "Actions" tab
  workflow_dispatch:

# -----------------------------------------------------------------
# ðŸ‘‡ ADD THIS BLOCK
# This grants the GITHUB_TOKEN write access to your repo's contents
permissions:
  contents: 'write'
  issues: 'write'
# -----------------------------------------------------------------

jobs:
  sync:
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout private repo'
        uses: 'actions/checkout@v4'
        with:
          # This token will now have the 'contents: write' permission
          token: '${{ secrets.GITHUB_TOKEN }}'
          # Fetch all history so we can merge
          fetch-depth: '0'

      - name: 'Configure Git'
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"
      - name: 'Pull from public repo'
        run: |
          # Add the public repo as a remote named 'upstream'
          git remote add upstream "https://github-actions:${{ secrets.GEMINI_CLI_ROBOT_GITHUB_PAT }}@github.com/google-gemini/gemini-cli.git"

          # Fetch the main branch from the public repo
          git fetch upstream main
          # Merge the changes from the public repo
          git merge upstream/main

      - name: 'Push changes to private mirror'
        run: |
          # This push will now be authenticated with write access
          git push origin '${{ github.ref_name }}'

      - name: 'Create issue on failure'
        if: 'failure()'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          DETAILS_URL: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
        run: |
          gh issue create \
            --title "Upstream Sync Failed" \
            --body "The workflow to sync from the public repository failed, likely due to a merge conflict. Please resolve the conflict manually. See the failed run for details: ${DETAILS_URL}"
